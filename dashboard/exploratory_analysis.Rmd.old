---
title: "exploratory analysis"
author: "Ria Pan"
date: "May 6, 2017"
output: md_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(PerformanceAnalytics)
library(Hmisc)
library(corrplot)
```

# Exploratory Analysis
  
```{r}
employee <- read_csv("IBM-HR-Employee-Attrition.csv")
quit <- filter(employee, Attrition=="Yes")
stayed <- filter(employee, Attrition=="No")
```

Graph of average monthly income across all roles faceted by gender

```{r}
gender_influence <- employee %>% group_by(Gender, JobRole) %>% summarise(average_monthly_income=mean(MonthlyIncome))
gender_influence_monthlyincome <- gender_influence %>% mutate(round_income=round(average_monthly_income))
ggplot(gender_influence_monthlyincome, aes(x=Gender,y=average_monthly_income, color=Gender))+
  geom_bar(stat = "identity",width=0.5,position=position_dodge())+
  geom_text(aes(label=round_income), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+
  facet_wrap(~JobRole)+
  theme_minimal()+
  scale_fill_manual(values=c("red", "blue"))+
  ggtitle("Monthly incomes across Job Roles")+
  scale_y_continuous(name="Average Monthly Income")
```

Graph of percent of employee lost across job roles

```{r}
Job_roles <- unique(quit$JobRole)
roles_quit <- str_count(Job_roles)
loss_by_job <- data_frame(Job=Job_roles, "Percentage loss"=(roles_quit/1470)*100)
loss_by_job <- loss_by_job %>% mutate(round_loss=round(loss_by_job$`Percentage loss`,digits=2))
loss_by_job <- arrange(loss_by_job, desc(round_loss))
ggplot(loss_by_job, aes(x=reorder(loss_by_job$Job,-loss_by_job$round_loss),y=loss_by_job$round_loss))+
  geom_bar(stat = "identity",width=0.5, position=position_dodge())+
  geom_text(aes(label=loss_by_job$round_loss), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))+
  labs(x="Job Roles",y="Percentage of Loss")+
  ggtitle("Loss percentage across different Job Roles")
```

Average monthly income based on Marital status

```{r}
testing <- employee %>% group_by(MaritalStatus) %>% summarise(mean=round(mean(MonthlyIncome),digits=0))
ggplot(testing, aes(x=testing$MaritalStatus,y=testing$mean))+
  geom_bar(stat = "identity",width=0.5, position=position_dodge())+
  geom_text(aes(label=testing$mean), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+
  labs(x="Marital Status",y="Average Monthly Income")+
  ggtitle("Put a ring on it")
```

Average monthly income across different levels of Relationship satisfaction

```{r}
RelSat <-employee %>% group_by(RelationshipSatisfaction) %>% summarise(mean=mean(MonthlyIncome))
ggplot(RelSat, aes(x=reorder(RelSat$RelationshipSatisfaction,-RelSat$mean),y=RelSat$mean))+
  geom_bar(stat = "identity",width=0.5, position=position_dodge())+
  geom_text(aes(label=round(RelSat$mean)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+
  labs(x="Relationship Satisfaction",y="Average Monthly Income")+
  ggtitle("99 Problems")
```

Average monthly income across different levels of Job Satisfaction

```{r}
JobSat <- employee %>% group_by( JobSatisfaction) %>% summarise(mean=mean(MonthlyIncome))
Jobsatty <- c("Low", "Medium", "High", "Very High")
ggplot(JobSat, aes(x=reorder(Jobsatty,-JobSat$mean),y=JobSat$mean))+
  geom_bar(stat = "identity",width=0.5, position=position_dodge())+
  geom_text(aes(label=round(JobSat$mean)), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5)+
  labs(x="Job Satisfaction",y="Average Monthly Income")+
  ggtitle("Mo Money Mo Problems")
```

There is no significant linear relationship between Work life balance and years since last promotion

```{r}
lin_reg <- lm(WorkLifeBalance~ YearsSinceLastPromotion, employee)
summary(lin_reg)
```

There is no relationship between performance rating and monthly income

```{r}
boxplot(MonthlyIncome~WorkLifeBalance,data = employee,xlab="PerformanceRating", ylab="MonthlyIncome")
```

The figure below is also the visualization of correlations between 5 features. 
The distribution of each variable is shown on the diagonal.
On the bottom of the diagonal : the bivariate scatter plots with a fitted line are isplayed
On the top of the diagonal : the value of the correlation plus the significance level as stars. 
Each significance level is associated to a symbol : p-values(0, 0.001, 0.01, 0.05, 0.1, 1) <=> symbols(“***”, “**”, “*”, “.”, " “)

```{r}
numeric <- employee[, c(1,4,6,7,10)]
#see correlation between features 
res2 <- rcorr(as.matrix(numeric)) # data must be a matrix 

flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
  )
}

flattenCorrMatrix(res2$r, res2$P)
```

```{r}
suppressWarnings(chart.Correlation(numeric, histogram=TRUE, pch=19))
```

The figure below shows female has higher avarage salary than males in IBM

```{r}
genderIncome <- employee %>% group_by(Gender) %>%
  summarise(meanSalary = mean(MonthlyIncome))
ggplot(genderIncome, aes (x = Gender, y = meanSalary)) + geom_bar(stat ="identity") + ggtitle("Mean monthly income between gender ")
```

The below plot shows gender distribution of gender across jobs

```{r}
ggplot(employee, aes(x = Gender, color = Gender)) +
  geom_bar()+ facet_wrap(~ JobRole)+ggtitle("Job distribution among gender")+ ggtitle("Job distribution across gender ")
```

The figure below illastrates the job distribution between male and female

```{r}
genderJobIncome <- employee  %>% group_by(Gender, JobRole) %>%
  summarise(meanSalarybyJob = mean(MonthlyIncome))
ggplot(genderJobIncome, aes(x = JobRole,y = meanSalarybyJob, color = Gender)) +
  geom_point() +ggtitle("Mean monthly income among diffrent jobs across gender ")
```

```{r}
employee$Attrition[employee$Attrition=="Yes"] <- 1
employee$Attrition[employee$Attrition=="No"] <- 0
integer_data <-employee[,c(1,2,4,6,7,10,11,13,14,15,17,19,20,21,24,25,26,28:35)]
integer_data$Attrition <-as.numeric(integer_data$Attrition)
correlation_data <- cor(integer_data)
corrplot(correlation_data,method="circle")
```

```{r}
quit <- filter(employee, Attrition==1)
ggplot(data=quit)+
  geom_point(aes(y=quit$MonthlyIncome, x=quit$BusinessTravel,color=JobRole))+
  labs(y="Monthly Income", x="Travels")+
  ggtitle("Attritions trend Income VS Travel")
```

```{r}
ggplot(data=employee)+
  geom_point(aes(y=employee$MonthlyIncome, x=employee$TotalWorkingYears,color=JobRole))+
  labs(y="Monthly Income", x="Working Years")+
  ggtitle("Observing trend of Income VS Working Years")
```

```{r}
ggplot(data=employee)+
  geom_point(aes(y=employee$PercentSalaryHike, x=employee$PerformanceRating, color=Attrition))+
  labs(y="Percentage Hike", x="Performance Rating")+
  ggtitle("Attritions trend Percentage Hike VS Performance Rating")
```
